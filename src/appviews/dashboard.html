<!DOCTYPE html>
<html>
	<head>
		<title>Scms dashboard</title>
		<style>
			.article0 {
				margin: 5px;
				border: 1px solid darkred;
			}
			.article1 {
				margin: 5px;
				border: 1px solid lightgrey;
			}
			.button {
				color: blue;
			}
		</style>
	</head>
	<body>
		<h1>Scms dashboard</h1>
		Upload an image/images:
		<form action="/app/upload" enctype="multipart/form-data" method="post">
			<input type="file" name="file" multiple>
			<input type="submit" value="Upload">
		</form><br>
		<a href="editor.html">New article</a>
		<p>These are your current articles:</p>
		<div id="articles">
			<% articles.forEach(el => { %>
				<div class="article<%= el.published %>" id="<%= el.id %>">
					<a href="/app/article/<%= el.id %>"><b><%= el.title %></b></a> (<%= el.date %>) -
					<a href="editeditor.html?id=<%= el.id %>">Edit</a> | <a class="button" href="#" onClick="delet(this)">Delete</a>
					<% if (!el.published) { %>
						| <b><a class="button" href="#" onClick="publish(this)">Publish</a></b>
					<% } %>
				</div>
			<% }) %>
		</div>
		<script>
			function publish(el) {
				if (!confirm("Are you sure you would like to publish this article?")) return;
				postid("/app/publish", el.parentNode.parentNode.id).then(() => {
					alert("Article successfully published");
					window.location.reload();
				}).catch(text => {
					alert("There was a problem in publishing your article: " + text);
				});
			}
			function delet(el) {
				if (!confirm("Are you sure you would like to delete this article?")) return;
				postid("/app/delete", el.parentNode.id).then(() => {
					alert("Article successfully deleted");
					window.location.reload();
				}).catch(text => {
					alert("There was a problem deleting your article: " + text);
				});
			}
			function postid(url, id) {
				return new Promise((resolve, reject) => {
					fetch(url, {
						method: "POST",
						body: JSON.stringify({id}),
						credentials: "same-origin",
						headers: {"Content-Type": "application/json"}
					}).then(r => {
						if (r.redirected) {
							window.location.href = "/app/login.html";
							reject("You are not logged in.");
						}
						return r.text();
					}).then(r => {
						if (r === "true") resolve();
						else reject(r);
					});
				});
			}
		</script>
	</body>
</html>
